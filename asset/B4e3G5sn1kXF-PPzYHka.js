import{u as B,R as o,ad as q,w as T,j as e}from"./DeTGZYeDNQQzD2Hg2g8t.js";import{S as H}from"./BDJlQZjGwGnoU6jH-S1z.js";import{W as M,A as U,S as V,F as W,d as g,L as x,b as j,a as c,c as f,I as y,e as D,f as G,g as K,h as N}from"./CmpVyqjHNaBPznX_UEM_.js";import{T as l}from"./CrtDogWriDzdj-4L2_mn.js";import{H as $,a as z}from"./BEiGjOnWPFLr4DRdwMio.js";import{u as J}from"./RfSsDsLnzSmF70stwuXp.js";import{u as O}from"./DMCex30FeWvvThtDj-pY.js";import"./C7xa3nx8OR7ix75ePtKc.js";import{G as Q}from"./aw3wHiZxDYoFCCMsbTym.js";import"./D95vS4HXwexk6O9L7iKW.js";import"./b9QDabEUvKe6AI27JKho.js";import{m as X}from"./BvFgMfzu9O3nUQg8aBdA.js";import{M as Y}from"./Dbk9dOAX_oM3Fs0-vij8.js";import{u as Z}from"./CfJSIGZnecuegB9U8XBd.js";function me(){const k=J(),p=O("LoginPage"),I=B(),[n,w]=o.useState(!1),[S,b]=o.useState(),[C,d]=o.useState(),h=o.useRef(null),{register:u,handleSubmit:E,formState:{errors:r},setError:a,setValue:L,clearErrors:R}=q(),i=()=>{var t;(t=h.current)==null||t.resetCaptcha(),L("captcha_key",void 0)},{handleInstanceChange:_,isCheckingInstance:A}=Z(a,R,"instance"),F=E(t=>{w(!0),b(void 0),d(void 0),k.rest.post(T.login(),{login:t.login,password:t.password,captcha_key:t.captcha_key,undelete:!1}).then(s=>{if("token"in s&&"settings"in s){k.setToken(s.token,!0);return}else if("ticket"in s){p.info("MFA Required",s),d(s);return}else p.error(s),a("login",{type:"manual",message:"Unknown Error"})}).catch(s=>{var v;if("captcha_key"in s){if(s.captcha_key[0]!=="captcha-required")a("login",{type:"manual",message:`Captcha Error: ${s.captcha_key[0]}`});else if(s.captcha_service!=="hcaptcha")a("login",{type:"manual",message:`Unsupported captcha service: ${s.captcha_service}`});else{b(s.captcha_sitekey),(v=h.current)==null||v.execute();return}i()}else if("message"in s){if(s.errors){const m=X(s.errors);m?a(m.field,{type:"manual",message:m.error}):a("login",{type:"manual",message:s.message})}else a("login",{type:"manual",message:s.message});i()}else p.error(s),a("login",{type:"manual",message:"Unknown Error"}),i()}).finally(()=>w(!1))}),P=t=>{L("captcha_key",t),F()};return S?e.jsx($,{captchaRef:h,sitekey:S,onVerify:P}):C?e.jsx(Y,{...C,close:()=>{d(void 0),i()}}):e.jsx(M,{children:e.jsxs(U,{children:[e.jsx(z,{children:e.jsxs(e.Fragment,{children:[e.jsx(H,{height:48,width:"auto"}),e.jsx(V,{noBranding:!0,children:"Log into Spacebar"})]})}),e.jsxs(W,{onSubmit:F,children:[e.jsxs(g,{marginBottom:!0,style:{marginTop:0},children:[e.jsxs(x,{error:!!r.instance,children:[e.jsx(j,{children:"Instance"}),A!=!1&&e.jsx(c,{children:e.jsxs(e.Fragment,{children:[e.jsx(l,{children:"-"}),"Checking"]})}),r.instance&&e.jsx(c,{children:e.jsxs(e.Fragment,{children:[e.jsx(l,{children:"-"}),r.instance.message]})})]}),e.jsx(f,{children:e.jsx(y,{type:"url",...u("instance",{required:!0,value:Q.routeSettings.wellknown}),placeholder:"Instance Root URL",onChange:_,error:!!r.instance,disabled:n})})]}),e.jsxs(g,{marginBottom:!0,children:[e.jsxs(x,{error:!!r.login,children:[e.jsx(j,{children:"Email"}),r.login&&e.jsx(c,{children:e.jsxs(e.Fragment,{children:[e.jsx(l,{children:"-"}),r.login.message]})})]}),e.jsx(f,{children:e.jsx(y,{type:"email",placeholder:"Email",autoFocus:!0,...u("login",{required:!0}),error:!!r.login,disabled:n})})]}),e.jsxs(g,{marginBottom:!0,children:[e.jsxs(x,{error:!!r.password,children:[e.jsx(j,{children:"Password"}),r.password&&e.jsx(c,{children:e.jsxs(e.Fragment,{children:[e.jsx(l,{children:"-"}),r.password.message]})})]}),e.jsx(f,{children:e.jsx(y,{type:"password",placeholder:"Password",...u("password",{required:!0}),error:!!r.password,disabled:n})})]}),e.jsx(D,{palette:"primary",type:"submit",disabled:n,children:"Login"}),e.jsxs(G,{children:[e.jsx(K,{children:"New to Spacebar?Â "}),e.jsx(N,{onClick:()=>{I("/register")},type:"button",children:"Register"})]})]})]})})}export{me as L};
