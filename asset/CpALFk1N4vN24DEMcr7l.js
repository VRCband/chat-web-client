import{q as x,o as $,f as l,a2 as U,j as a,C as B}from"./DeTGZYeDNQQzD2Hg2g8t.js";import{m as G}from"./CuA_0ud078oJ-lK1_bt7.js";import"./Bb1ggiTpiYWP0Snah0HS.js";import{u as W}from"./RfSsDsLnzSmF70stwuXp.js";import{u as K}from"./DMCex30FeWvvThtDj-pY.js";import{M as A}from"./CiW7RIy8_7rKRg9LP8yw.js";import{d as Y}from"./fynzmAtJ_PmpHXIxRwqH.js";import"./D95vS4HXwexk6O9L7iKW.js";import{S as z}from"./b9QDabEUvKe6AI27JKho.js";import{I as J}from"./B386L9xRsGPuiIWZWLBJ.js";import{I as X}from"./CDt1z0NHkbfIQkt7ZP5a.js";import{A as Q}from"./Dxel67A2n6SZoyZZCfd0.js";import{A as V}from"./BPu9cIf5i7jL_W-c-wg3.js";import{M as Z}from"./BDfxB6zSQrLril8XoPAv.js";import{M as ee}from"./Bzmaguq9WvKRfPslYEly.js";const te=x.div`
	padding: 0 16px;
	margin-bottom: 25px;
`,ne=x.div`
	background-color: var(--background-primary);
	padding: 0 16px;
	border-radius: 10px;
	display: flex;
	flex-direction: column;
`,se=x.div`
	display: flex;
	flex-direction: row;
`,oe=x.div`
	flex: 0 0 auto;
	position: sticky;
`,re=x.div`
	height: 45px;
	display: flex;
	justify-content: center;
	align-items: center;
`;function ae({channel:r}){var T;const u=W(),E=K("MessageInput"),[p,y]=l.useState(""),[i,f]=l.useState([]),[b,C]=l.useState(!1),h=l.useRef(null),[c,j]=l.useState(null),v=l.useCallback(Y(()=>r.stopTyping(),1e4),[r]),M=l.useCallback(()=>!(!i.length&&(!p||!p.trim()||!p.replace(/\r?\n|\r/g,""))),[i,p]),k=l.useCallback(e=>{const o=/:(\w+):/g;return e.replace(o,(n,t)=>{const s=Array.from(u.emojis.all.values()).find(m=>m.name===t);return s?`<:${t}:${s.id}>`:n})},[u.emojis]),R=l.useCallback(async()=>{r.stopTyping();const e=u.experiments.isTreatmentEnabled("message_queue",2),o=!u.experiments.isTreatmentEnabled("message_queue",1);if(!M()&&!e)return;const n=k(p),t=n,s=i;y(""),f([]),v(!0);const m=z.generate(),g=u.queue.add({id:m,content:t,files:s,author:u.account.raw,channel_id:r.id,guild_id:r.guildId,timestamp:new Date().toISOString(),type:U.Default});if(o)try{let d;if(s.length>0){const S=new FormData;S.append("payload_json",JSON.stringify({contentForSending:n,nonce:m})),s.forEach((H,L)=>{S.append(`files[${L}]`,H)}),d=S}else d={content:n,nonce:m};await r.sendMessage(d,g)}catch(d){const S=d instanceof Error?d.message:typeof d=="string"?d:"Unknown error";g.fail(S)}else e&&g.fail("Message queue experiment")},[p,i,r,M]),w=e=>{e.ctrlKey&&e.key==="Enter"&&(e.preventDefault(),R()),!e.shiftKey&&e.key==="Enter"&&(e.preventDefault(),R()),e.key==="Escape"&&i.length>0&&f([]),v(!0)},I=e=>{y(e),r.startTyping()},N=e=>{if(e.length!==0){if(e.length>A||i.length+e.length>A){G.push({type:"error",title:"Too many attachments",error:`You can only attach ${A} files at once.`});return}f(o=>[...o,...e])}},O=()=>{y("")},D=()=>{const e=document.querySelector('[contenteditable="true"]');if(e){e.focus();const o=window.getSelection();if(o&&o.rangeCount>0){const n=o.getRangeAt(0);j({startContainer:n.startContainer,startOffset:n.startOffset,endContainer:n.endContainer,endOffset:n.endOffset})}}C(o=>!o)},_=e=>{if(!e)return;const o=document.querySelector('[contenteditable="true"]');if(!o)return;if(e.isCustom&&e.imageUrl){const t=Array.from(u.emojis.all.values()).find(s=>s.name===e.names[0]);if(t){const s=document.createElement("img");s.className="emoji",s.src=t.imageUrl,s.alt=t.name,s.title=t.name,s.setAttribute("data-emoji-name",t.name),s.setAttribute("data-emoji-id",t.id),q(o,s)}}else P(o,e.emoji);const n=F(o.innerHTML);y(n),C(!1),r.startTyping()},q=(e,o)=>{e.focus();const n=window.getSelection();if(c&&n)try{const t=document.createRange();t.setStart(c.startContainer,c.startOffset),t.setEnd(c.endContainer,c.endOffset),n.removeAllRanges(),n.addRange(t)}catch(t){E.warn("Failed to restore saved selection:",t);const s=document.createRange();s.selectNodeContents(e),s.collapse(!1),n.removeAllRanges(),n.addRange(s)}if(n&&n.rangeCount>0){const t=n.getRangeAt(0);return t.deleteContents(),t.insertNode(o),t.setStartAfter(o),t.collapse(!0),n.removeAllRanges(),n.addRange(t),j(null),!0}return!1},P=(e,o)=>{e.focus();const n=window.getSelection();if(c&&n)try{const t=document.createRange();t.setStart(c.startContainer,c.startOffset),t.setEnd(c.endContainer,c.endOffset),n.removeAllRanges(),n.addRange(t)}catch(t){E.warn("Failed to restore saved selection:",t);const s=document.createRange();s.selectNodeContents(e),s.collapse(!1),n.removeAllRanges(),n.addRange(s)}if(n&&n.rangeCount>0){const t=n.getRangeAt(0);t.deleteContents();const s=document.createTextNode(o);return t.insertNode(s),t.collapse(!1),n.removeAllRanges(),n.addRange(t),j(null),!0}return!1},F=e=>{const o=document.createElement("div");return o.innerHTML=e,o.querySelectorAll("img.emoji").forEach(t=>{var m;const s=t.getAttribute("data-emoji-name");if(s){const g=document.createTextNode(`:${s}:`);(m=t.parentNode)==null||m.replaceChild(g,t)}}),o.innerHTML=o.innerHTML.replace(/<br>/g,`
`),o.textContent||""};return a.jsx(te,{children:a.jsxs(ne,{children:[a.jsx(V,{attachments:i,remove:e=>{i.length!==0&&(i.length===1?f([]):f(i.filter((o,n)=>n!==e)))}}),a.jsxs(se,{children:[a.jsx(oe,{children:r.hasPermission("ATTACH_FILES")&&r.hasPermission("SEND_MESSAGES")&&a.jsx(Q,{append:N,clearInput:O})}),a.jsx(ee,{id:"messageinput",value:p,placeholder:r.hasPermission("SEND_MESSAGES")?`Message ${r.type===B.DM?(T=r.recipients)==null?void 0:T[0].username:"#"+r.name}`:"You do not have permission to send messages in this channel.",disabled:!r.hasPermission("SEND_MESSAGES"),onChange:I,onKeyDown:w}),r.hasPermission("SEND_MESSAGES")&&a.jsxs(a.Fragment,{children:[a.jsx(re,{children:a.jsx(X,{ref:h,onClick:D,children:a.jsx(J,{icon:"mdiStickerEmoji",size:"24px",color:"var(--text)"})})}),a.jsx(Z,{isOpen:b,onClose:()=>C(!1),buttonRef:h,onEmojiSelect:_})]})]})]})})}const Ee=$(ae);export{Ee as M};
